<!DOCTYPE html>
<html>
<head>
<!--
<meta http-equiv="refresh" content="2" />
-->
<style>
body {
margin: auto 10%;
}
section {
  page-break-inside: avoid;
  border: 0 solid #eee;
}
/*
section section + section {
  border-color: #ddd;
  border-width: 0 0 0 0;
}
body > section {
  border-color: #777;
  border-width: medium 0 0 0;
}
*/
p {
  text-align: justify;
}
h3 {
}
body script {
  display: block;
  white-space: pre;
  font-family: monospace;
  margin: 1em 0;
}
#tests {
  display: none;
}

tdÂ {
  vertical-align: top;
}
pre {
  margin: 1em 2em;
}
textarea:hover {
  cursor: default;
}
textarea#input:hover {
  background-color: #f6f6ff;
}
textarea.invalid {
  background-color: #fee;
}
textarea#input.invalid {
  background-color: #fee;
}
</style>
<script>
  "use strict";
  function init() {
    pretty('input');
    pretty('output');
    var input = document.getElementById('input');
    var output = document.getElementById('output');
    input.addEventListener('keyup', user_update_output, true);
    output.addEventListener('keyup', user_update_input, true);

    tests();
    update_output();
  }

  function compare(json_answer1, json_answer2) {
    var answer1 = JSON.parse(json_answer1);
    var answer2 = JSON.parse(json_answer2);
    var nodes1 = Object.keys(answer1);
    var nodes2 = Object.keys(answer2);
    if(nodes1.length != nodes2.length) {
      return 'different amount of nodes';
    }
    nodes1.sort();
    nodes2.sort();
    for (var i in nodes1) {
      var node1 = nodes1[i];
      var node2 = nodes1[i];
      if (node1 != node2) {
        return 'different set of nodes';
      }
    }
    for (var key in answer1) {
      var objects2 = answer2[key];
      if (typeof(objects2) == typeof(undefined)) {
        return 'answer2 is missing a key ' + key;
      }
      var objects1 = answer1[key];
      if (objects1.length != objects2.length) {
        return 'object amounts differ for key ' + key;
      }
      objects2.sort();
      objects1.sort();
      for (var i in objects1) {
        var object1 = objects1[i];
        var object2 = objects2[i];
        if (object1 != object2) {
          return 'objects differ for key ' + key;
        }
      }
    }
  }

  function test(i) {
    var input_element = document.getElementById('input-' + i);
    var output_element = document.getElementById('output-' + i);
    var json_input = input_element.innerHTML;
    var json_example = output_element.innerHTML;
    var json_output = transform(json_input);
    var error = compare(json_output, json_example);
    if (typeof(error) != typeof(undefined)) {
      console.log('problem detected while executing test-' + i);
      console.log(error);
    }
  }

  function validate_input() {
    var input_element = document.getElementById('input');
    var json_input = input_element.value;
    try {
      var input = JSON.parse(json_input);
    } catch(e) {
      input_element.setAttribute('class', 'invalid')
      return;
    }
    input_element.removeAttribute('class')
  }

  function validate_output() {
    var output_element = document.getElementById('output');
    var json_output = output_element.value;
    try {
      var output = JSON.parse(json_output);
    } catch(e) {
      output_element.setAttribute('class', 'invalid')
      return;
    }
    output_element.removeAttribute('class')
  }

  function validate_fields() {
    validate_input();
    validate_output();
  }

  function user_update_input() {
    try {
      update_input();
    } catch (e) {
    }
  }

  function user_update_output() {
    try {
      update_output();
    } catch (e) {
    }
  }

  function update_input() {
    validate_fields();
    var input_element = document.getElementById('input');
    var output_element = document.getElementById('output');
    var json_output = output_element.value;
    var json_input = detransform(json_output);
    var input = JSON.parse(json_input);
    var pretty = JSON.stringify(input, null, '  ');
    input_element.value = pretty;
    validate_fields();
  }

  function update_output() {
    validate_fields();
    var input_element = document.getElementById('input');
    var output_element = document.getElementById('output');
    var json_input = input_element.value;
    var json_output = transform(json_input);
    var output = JSON.parse(json_output);
    var pretty = JSON.stringify(output, null, '  ');
    output_element.value = pretty;
    validate_fields();
  }

  function tests() {
    test(1);
  }

  function pretty(field) {
    var element = document.getElementById(field);
    var json = element.value;
    var content = JSON.parse(json);
    var pretty = JSON.stringify(content, null, '  ');
    element.value = pretty;
  }

  function detransform(json_output) {
    var output = JSON.parse(json_output);
    var nodes = [];
    var objects = [];
    for (var node in output) {
      nodes.push(node);
      var store = output[node];
      for (var i in store) {
        var obj = store[i];
        objects.push(obj);
      }
    }
    nodes.sort();
    objects.sort();
    var input = {}
    input['nodes'] = nodes;
    input['objects'] = objects;
    var json_input = JSON.stringify(input);
    return json_input;
  }

  window.addEventListener('load', init, false);
</script>
</head>
<body>
<p>
582615: Overlay and P2P Networks, Spring 2013
</p>

<section>
<h1>Spoiler Package II</h1>

<p>
Many course participants were unfamiliar with the rules for doing quotations.
Therefore, no minus points were given for failure in quotation or failure in pointing out sources.
However, please check the list of <a href="problems.html">common quotation problems</a>
to avoid loosing points on other courses. Double check the rules before attempting to do
scientific publications, such as a master's thesis.
</p>
<p>
Direct quotes were ignored while grading the assignments.
Thus, a low score for an assignment does not necessarily imply that the answer was incorrect.
Furthermore, it was possible to get full points regardless of some errors.
Therefore, a high score does not imply that everything in the answer was correct.
</p>

<section>
<h2>Assignment 5, Spoiler</h2>

<p>
In Chord the identifier space forms a ring that is used
to decide which node is responsible for which object.
Each node is responsible for the object which identifier
matches that of the node, as well as all objects between
that node and the preceeding node on the ring.
</p>

<p>
Below you'll find an example how a simplified json input
would transform.
</p>
<table>
<tr>
<th>input</th>
<th>output</th>
</tr>
<tr><td>
<textarea id="input" rows="20">
{
  "nodes": ["00036", "34783", "76321", "93125"],
  "objects": ["00737", "01105", "01564", "76475",
              "76493", "76494", "76512", "93125",
              "93127"]
}
</textarea>
</td><td>
<textarea id="output" rows="20" readonly="readonly">
{
  "00036": ["93127"],
  "34783": ["00737", "01105", "01564"],
  "76321": [],
  "93125": ["76475", "76493", "76494", "76512", "93125"]
}
</textarea>
</td></tr></table>
<p>
Note that json is agnostic to the order of keys in the object,
and the assignment definition did not specify the order for
object identifiers in the list.
<!--
 The keys and identifiers are
ordered here by their size for convenience of the reader.
-->
You might write the transformation in javascript as follows.
</p>
<script>
function transform(json_input) {
  var input = JSON.parse(json_input);
  var nodes = input['nodes'];
  var objects = input['objects'];
  nodes.sort();
  objects.sort();
  var output = {};
  var obj = objects.shift();
  var node = nodes.shift();
  var first_node = node;
  while (typeof(node) != typeof(undefined)) {
    var store = [];
    while (obj <= node) {
      store.push(obj);
      obj = objects.shift();
    }
    output[node] = store;
    node = nodes.shift();
  }
  if (typeof(first_node) != typeof(undefined)) {
    var first_store = output[first_node];
    while (typeof(obj) != typeof(undefined)) {
      first_store.push(obj);
      obj = objects.shift();
    }
  }
  var json_output = JSON.stringify(output);
  return json_output;
}
</script>

<p></p>
</section>

<!--
<section>
<h2>Assignment 6, Spoiler</h2>

<section>
<h3>a.</h3>
<p>

</p>
<p>
   [1] <a href=""></a> <br />
</p>
</section>
</section>
-->
</section>

<div id="tests">
<pre id="input-1">
{
  "nodes": ["00036", "34783", "76321", "93125"],
  "objects": ["00737", "01105", "01564", "76475",
              "76493", "76494", "76512", "93125",
              "93127"]
}
</pre>
<pre id="output-1">
{
  "00036": ["93127"],
  "34783": ["00737", "01105", "01564"],
  "76321": [],
  "93125": ["76475", "76493", "76494", "76512", "93125"]
}
</pre>
</div>
</body>
</html>
